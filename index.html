<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
    <title>Gesti√≥n de Postres</title>
    <meta name="theme-color" content="#667eea">
    <style>
        /* Base */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; -webkit-font-smoothing:antialiased; color:#222; }
        a { color: inherit; }

        /* Layout container */
        .container { max-width:1200px; margin:0 auto; padding:20px; }

        /* LOGIN / REGISTER */
        .login-container { display:flex; justify-content:center; align-items:center; min-height:100vh; padding: 16px; }
        .login-box {
            background:white;
            padding:28px;
            border-radius:14px;
            box-shadow:0 10px 30px rgba(0,0,0,0.22);
            width:100%;
            max-width:420px;
        }
        .login-box h2 { color:#667eea; margin-bottom:18px; text-align:center; font-size:20px; }
        .input-group { margin-bottom:14px; }
        .input-group label { display:block; margin-bottom:6px; color:#333; font-weight:600; font-size:13px; }
        .input-group input, .input-group select {
            width:100%;
            padding:12px 14px;
            border:2px solid #e6e6e6;
            border-radius:10px;
            font-size:15px;
            transition:border-color .18s, box-shadow .18s;
        }
        .input-group input:focus, .input-group select:focus { outline:none; border-color:#667eea; box-shadow:0 6px 18px rgba(102,126,234,0.08); }

        .btn {
            width:100%;
            padding:14px;
            background:#667eea;
            color:white;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:700;
            cursor:pointer;
            transition:background .18s, transform .06s;
        }
        .btn:active { transform:translateY(1px); }
        .btn:hover { background:#5568d3; }

        .btn-secondary { background:#6c757d; margin-top:8px; }
        .btn-secondary:hover { background:#5a6268; }

        .alert { padding:12px; border-radius:8px; margin-bottom:12px; display:none; font-size:14px; }
        .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
        .alert-error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }

        /* APP */
        .app-container { display:none; padding-bottom: 80px; } /* bottom padding for mobile comfortable spacing */
        .header {
            background:white;
            padding:14px 16px;
            border-radius:12px;
            margin-bottom:14px;
            box-shadow:0 5px 15px rgba(0,0,0,0.08);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }
        .header h1 { color:#667eea; font-size:18px; margin:0; }
        .logout-btn {
            padding:8px 12px;
            background:#dc3545;
            color:white;
            border:none;
            border-radius:10px;
            cursor:pointer;
            font-weight:700;
            font-size:14px;
        }

        .tabs { display:flex; gap:10px; margin-bottom:12px; }
        .tab {
            flex:1;
            padding:10px;
            background:white;
            border:none;
            border-radius:10px;
            cursor:pointer;
            font-size:15px;
            font-weight:700;
            transition:all .12s;
            box-shadow:0 3px 10px rgba(0,0,0,0.06);
        }
        .tab.active { background:#667eea; color:white; }

        .tab-content { display:none; background:white; padding:18px; border-radius:12px; box-shadow:0 5px 15px rgba(0,0,0,0.06); }
        .tab-content.active { display:block; }

        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; margin-bottom:12px; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:10px; margin-bottom:14px; }

        .stat-card {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:white;
            padding:12px;
            border-radius:10px;
            box-shadow:0 3px 10px rgba(0,0,0,0.06);
            min-height:72px;
            display:flex;
            flex-direction:column;
            justify-content:center;
            gap:6px;
        }
        .stat-card h3 { font-size:12px; margin:0; opacity:0.95; font-weight:700; }
        .stat-card .value { font-size:18px; font-weight:800; }

        /* Tables responsive wrapper */
        .table-wrap { width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch; margin-top:8px; }
        table { width:100%; min-width:700px; border-collapse:collapse; margin-top:6px; }
        th, td { padding:10px 12px; text-align:left; border-bottom:1px solid #eee; font-size:14px; }
        th { background:#f8f9fa; font-weight:700; color:#333; font-size:13px; position:relative; }
        .delete-btn { background:#dc3545; color:white; border:none; padding:8px 10px; border-radius:6px; cursor:pointer; font-size:13px; }
        .delete-btn:hover { background:#c82333; }

        .loading { text-align:center; padding:16px; color:#666; }

        .error-box { background:#fff3cd; border:2px solid #ffc107; padding:12px; border-radius:8px; margin:12px 0; font-size:13px; }
        .error-box h4 { color:#856404; margin-bottom:8px; font-size:15px; }
        .error-box code { display:block; background:#fff; padding:8px; border-radius:4px; margin-top:8px; font-size:12px; overflow-x:auto; }

        /* Smaller devices adjustments */
        @media (max-width: 680px) {
            .container { padding: 12px; }
            .login-box { padding:18px; border-radius:12px; max-width:420px; }
            .login-box h2 { font-size:18px; }
            .input-group input, .input-group select { padding:12px; font-size:15px; }
            .btn { padding:14px; font-size:16px; border-radius:10px; }
            .header { padding:12px; border-radius:12px; }
            .header h1 { font-size:16px; }
            .logout-btn { padding:8px 10px; font-size:13px; }
            .tabs { gap:8px; }
            .tab { padding:10px; font-size:14px; border-radius:10px; }
            .tab-content { padding:14px; border-radius:12px; }
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .stat-card { padding:12px; display:flex; flex-direction:row; align-items:center; justify-content:space-between; }
            .stat-card h3 { font-size:13px; }
            .stat-card .value { font-size:18px; }
            table { min-width:640px; }
            th, td { padding:10px 8px; font-size:13px; }
        }

        /* Very small phones */
        @media (max-width: 420px) {
            .login-box { padding:14px; }
            .input-group label { font-size:12px; }
            .input-group input { padding:10px; font-size:14px; }
            .btn { padding:12px; font-size:15px; }
            .header h1 { font-size:15px; }
            th, td { font-size:12px; padding:8px; }
            .delete-btn { padding:7px 8px; font-size:12px; }
        }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2>üç∞ Mi Emprendimiento de Postres</h2>
            <div id="loginAlert" class="alert"></div>
            <div class="input-group">
                <label>Correo Electr√≥nico</label>
                <input type="email" id="loginEmail" placeholder="tu@email.com" />
            </div>
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <button class="btn" onclick="login()">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="showRegister()">Registrarse</button>
        </div>
    </div>

    <!-- REGISTER -->
    <div id="registerScreen" class="login-container hidden">
        <div class="login-box">
            <h2>Crear Cuenta</h2>
            <div id="registerAlert" class="alert"></div>
            <div class="input-group">
                <label>Correo Electr√≥nico</label>
                <input type="email" id="registerEmail" placeholder="tu@email.com" />
            </div>
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="registerPassword" placeholder="M√≠nimo 6 caracteres" />
            </div>
            <button class="btn" onclick="register()">Crear Cuenta</button>
            <button class="btn btn-secondary" onclick="showLogin()">Volver al Login</button>
        </div>
    </div>

    <!-- APP -->
    <div id="appScreen" class="app-container">
        <div class="container">
            <div class="header">
                <h1>üç∞ Gesti√≥n de Postres</h1>
                <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <div id="errorContainer"></div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab(event,'cuentas')">üìä Cuentas</button>
                <button class="tab" onclick="switchTab(event,'pedidos')">üì¶ Pedidos</button>
            </div>

            <div id="cuentasTab" class="tab-content active">
                <h2 style="font-size:16px; margin-bottom:8px;">Gesti√≥n de Cuentas</h2>

                <div class="input-group">
                    <label>Ver estad√≠sticas por:</label>
                    <select id="periodSelect" onchange="updateStats()">
                        <option value="day">Hoy</option>
                        <option value="week">Esta Semana</option>
                        <option value="month">Este Mes</option>
                    </select>
                </div>

                <div class="stats-grid" aria-hidden="false">
                    <div class="stat-card">
                        <h3>Ingresos</h3>
                        <div class="value" id="totalIngresos">‚Ç°0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Gastos</h3>
                        <div class="value" id="totalGastos">‚Ç°0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Ganancia</h3>
                        <div class="value" id="totalGanancia">‚Ç°0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Margen</h3>
                        <div class="value" id="margen">0%</div>
                    </div>
                </div>

                <h3 style="margin-top:6px; font-size:16px;">Registrar Gasto</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label>Concepto</label>
                        <input type="text" id="gastoConcepto" placeholder="Ej: Ingredientes, Envases, Transporte" />
                    </div>
                    <div class="input-group">
                        <label>Monto (‚Ç°)</label>
                        <input type="number" id="gastoMonto" placeholder="0" min="0" />
                    </div>
                </div>
                <button class="btn" onclick="registrarGasto()">üí∞ Registrar Gasto</button>

                <h3 style="margin-top:12px; font-size:16px;">Historial de Gastos</h3>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Acci√≥n</th></tr>
                        </thead>
                        <tbody id="gastosTable"><tr><td colspan="4" class="loading">Cargando...</td></tr></tbody>
                    </table>
                </div>

                <h3 style="margin-top:12px; font-size:16px;">Historial de Ingresos (Pedidos)</h3>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>Fecha</th><th>Cliente</th><th>Monto</th></tr>
                        </thead>
                        <tbody id="ingresosTable"><tr><td colspan="3" class="loading">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </div>

            <div id="pedidosTab" class="tab-content">
                <h2 style="font-size:16px; margin-bottom:8px;">Gesti√≥n de Pedidos</h2>

                <h3 style="font-size:14px;">Nuevo Pedido</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label>Nombre del Cliente</label>
                        <input type="text" id="clienteNombre" placeholder="Juan P√©rez" />
                    </div>
                    <div class="input-group">
                        <label>Tel√©fono</label>
                        <input type="tel" id="clienteTelefono" placeholder="8888-8888" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Postre</label>
                        <input type="text" id="postreNombre" placeholder="Cheesecake de fresa" />
                    </div>
                    <div class="input-group">
                        <label>Precio (‚Ç°)</label>
                        <input type="number" id="postrePrecio" placeholder="0" min="0" />
                    </div>
                </div>
                <div class="input-group">
                    <label>Ruta de Entrega</label>
                    <input type="text" id="rutaEntrega" placeholder="Direcci√≥n completa" />
                </div>
                <div class="input-group">
                    <label>Fecha de Entrega</label>
                    <input type="date" id="fechaEntrega" />
                </div>
                <button class="btn" onclick="registrarPedido()">üì¶ Registrar Pedido</button>

                <h3 style="margin-top:12px; font-size:16px;">Pedidos Activos</h3>
                <div class="table-wrap">
                    <table>
                        <thead>
                            <tr><th>Cliente</th><th>Tel√©fono</th><th>Postre</th><th>Precio</th><th>Entrega</th><th>Ruta</th><th>Acci√≥n</th></tr>
                        </thead>
                        <tbody id="pedidosTable"><tr><td colspan="7" class="loading">Cargando...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDjwYd8J_9g7kfgluxZFWMKKOn2OoBkmBQ",
            authDomain: "postres-app-86dac.firebaseapp.com",
            projectId: "postres-app-86dac",
            storageBucket: "postres-app-86dac.firebasestorage.app",
            messagingSenderId: "353099071108",
            appId: "1:353099071108:web:88b2d032e4a2400d2a0cd1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.currentUser = null;

        function showErrorHelper(error) {
            const errorContainer = document.getElementById('errorContainer');
            if (!error) { errorContainer.innerHTML = ''; return; }

            if (error.code === 'permission-denied') {
                errorContainer.innerHTML = `
                    <div class="error-box">
                        <h4>üîí Error de Permisos de Firestore</h4>
                        <p>Las reglas de seguridad est√°n bloqueando el acceso. Sigue estos pasos:</p>
                        <ol>
                            <li>Ve a la <a href="https://console.firebase.google.com" target="_blank">Consola de Firebase</a></li>
                            <li>Selecciona tu proyecto: <strong>postres-app-86dac</strong></li>
                            <li>Ve a <strong>Firestore Database</strong> ‚Üí <strong>Reglas</strong></li>
                            <li>Copia y pega estas reglas:</li>
                        </ol>
                        <code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}</code>
                        <p style="margin-top:10px;">Luego haz clic en <strong>Publicar</strong> y recarga esta p√°gina.</p>
                    </div>`;
            } else if (error.code === 'failed-precondition' || (error.message && error.message.includes('index'))) {
                const indexUrl = error.message ? error.message.match(/https:\/\/[^\s]+/) : null;
                errorContainer.innerHTML = `
                    <div class="error-box">
                        <h4>üìã Falta Crear √çndice en Firestore</h4>
                        <p>Firebase necesita un √≠ndice para esta consulta.</p>
                        ${indexUrl ? `<p><a href="${indexUrl[0]}" target="_blank" style="color:#667eea; font-weight:bold;">üëâ Haz clic aqu√≠ para crear el √≠ndice</a></p>` : ''}
                        <p>Despu√©s de crear el √≠ndice, espera 1-2 minutos y recarga la p√°gina.</p>
                    </div>`;
            } else {
                errorContainer.innerHTML = `<div class="error-box"><h4>Error</h4><p>${error.message || error}</p></div>`;
            }
        }

        // Auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('registerScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'block';
                loadData();
            } else {
                window.currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appScreen').style.display = 'none';
            }
        });

        window.showRegister = () => {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'flex';
        };

        window.showLogin = () => {
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        };

        window.register = async () => {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            if (!email || !password) { showAlert('registerAlert','Por favor completa todos los campos','error'); return; }
            if (password.length < 6) { showAlert('registerAlert','La contrase√±a debe tener al menos 6 caracteres','error'); return; }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showAlert('registerAlert','‚úÖ Cuenta creada exitosamente','success');
            } catch (error) {
                console.error('Error de registro:', error);
                let mensaje = 'Error al crear cuenta';
                if (error.code === 'auth/email-already-in-use') mensaje = 'Este correo ya est√° registrado';
                else if (error.code === 'auth/invalid-email') mensaje = 'Correo electr√≥nico inv√°lido';
                else if (error.code === 'auth/weak-password') mensaje = 'La contrase√±a es muy d√©bil';
                showAlert('registerAlert', mensaje, 'error');
            }
        };

        window.login = async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { showAlert('loginAlert','Por favor completa todos los campos','error'); return; }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Error de login:', error);
                let mensaje = 'Error al iniciar sesi√≥n';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') mensaje = 'Correo o contrase√±a incorrectos';
                else if (error.code === 'auth/invalid-email') mensaje = 'Correo electr√≥nico inv√°lido';
                showAlert('loginAlert', mensaje, 'error');
            }
        };

        window.logout = async () => {
            await signOut(auth);
        };

        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            setTimeout(() => alertDiv.style.display = 'none', 4000);
        }

        // Fix: accept event param to avoid undefined global event
        window.switchTab = (evt, tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
            const el = document.getElementById(tab + 'Tab');
            if (el) el.classList.add('active');
            // fallback: add active to content by id
            const content = document.getElementById(tab + 'Tab');
            if (!content) {
                // previous structure uses id "cuentasTab" / "pedidosTab"
                const content2 = document.getElementById(tab + 'Tab');
            }
            // proper content show:
            const contentId = tab + 'Tab';
            const contentElem = document.getElementById(contentId);
            if (contentElem) contentElem.classList.add('active');
            // Show by known ids
            if (tab === 'cuentas') {
                document.getElementById('cuentasTab').classList.add('active');
                document.getElementById('pedidosTab').classList.remove('active');
                updateStats();
            } else if (tab === 'pedidos') {
                document.getElementById('pedidosTab').classList.add('active');
                document.getElementById('cuentasTab').classList.remove('active');
            }
        };

        // Registrar gasto
        window.registrarGasto = async () => {
            const concepto = document.getElementById('gastoConcepto').value.trim();
            const monto = parseFloat(document.getElementById('gastoMonto').value);
            if (!concepto || !monto || monto <= 0) { alert('‚ö†Ô∏è Por favor completa todos los campos correctamente'); return; }

            try {
                const gastoData = {
                    userId: window.currentUser.uid,
                    concepto,
                    monto,
                    fecha: Timestamp.now(),
                    timestamp: Date.now()
                };
                const docRef = await addDoc(collection(db, 'gastos'), gastoData);
                document.getElementById('gastoConcepto').value = '';
                document.getElementById('gastoMonto').value = '';
                await loadGastos();
                await updateStats();
                alert(`‚úÖ Gasto registrado exitosamente\nüí∞ Monto: ‚Ç°${monto.toLocaleString()}\nüìù Concepto: ${concepto}`);
            } catch (error) {
                console.error('‚ùå Error al registrar gasto:', error);
                showErrorHelper(error);
                let mensaje = 'Error al registrar gasto';
                if (error.code === 'permission-denied') mensaje = 'üîí Error de permisos. Revisa el cuadro amarillo arriba con las instrucciones.';
                alert(mensaje);
            }
        };

        // Registrar pedido + crear ingreso
        window.registrarPedido = async () => {
            const nombre = document.getElementById('clienteNombre').value.trim();
            const telefono = document.getElementById('clienteTelefono').value.trim();
            const postre = document.getElementById('postreNombre').value.trim();
            const precio = parseFloat(document.getElementById('postrePrecio').value);
            const ruta = document.getElementById('rutaEntrega').value.trim();
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            if (!nombre || !telefono || !postre || !precio || !ruta || !fechaEntrega || precio <= 0) { alert('‚ö†Ô∏è Por favor completa todos los campos correctamente'); return; }

            try {
                const pedidoData = {
                    userId: window.currentUser.uid,
                    nombre, telefono, postre, precio, ruta, fechaEntrega,
                    fecha: Timestamp.now(),
                    timestamp: Date.now()
                };
                await addDoc(collection(db, 'pedidos'), pedidoData);

                const ingresoData = {
                    userId: window.currentUser.uid,
                    cliente: nombre,
                    monto: precio,
                    fecha: Timestamp.now(),
                    timestamp: Date.now()
                };
                await addDoc(collection(db, 'ingresos'), ingresoData);

                document.getElementById('clienteNombre').value = '';
                document.getElementById('clienteTelefono').value = '';
                document.getElementById('postreNombre').value = '';
                document.getElementById('postrePrecio').value = '';
                document.getElementById('rutaEntrega').value = '';
                document.getElementById('fechaEntrega').value = '';

                await loadPedidos();
                await loadIngresos();
                await updateStats();

                alert(`‚úÖ Pedido registrado exitosamente\nüë§ Cliente: ${nombre}\nüç∞ Postre: ${postre}\nüí∞ Precio: ‚Ç°${precio.toLocaleString()}`);
            } catch (error) {
                console.error('‚ùå Error al registrar pedido:', error);
                showErrorHelper(error);
                alert('Error al registrar pedido. Revisa la consola y el cuadro amarillo arriba.');
            }
        };

        window.eliminarGasto = async (id) => {
            if (!confirm('¬øEst√°s seguro de eliminar este gasto?')) return;
            try {
                await deleteDoc(doc(db, 'gastos', id));
                await loadGastos();
                await updateStats();
                alert('‚úÖ Gasto eliminado');
            } catch (error) {
                console.error('Error al eliminar gasto:', error);
                alert('Error al eliminar: ' + (error.message || error));
            }
        };

        window.eliminarPedido = async (id) => {
            if (!confirm('¬øMarcar este pedido como completado?')) return;
            try {
                await deleteDoc(doc(db, 'pedidos', id));
                await loadPedidos();
                alert('‚úÖ Pedido completado');
            } catch (error) {
                console.error('Error al completar pedido:', error);
                alert('Error al completar: ' + (error.message || error));
            }
        };

        // Carga inicial
        async function loadData() {
            try {
                await Promise.all([loadGastos(), loadPedidos(), loadIngresos()]);
                await updateStats();
            } catch (err) {
                console.error('Error cargando datos iniciales:', err);
            }
        }

        // Helper: convertir campo fecha (Timestamp|number|missing) a Date
        function toDateSafe(field) {
            if (!field) return null;
            // Firestore Timestamp
            if (typeof field.toDate === 'function') return field.toDate();
            // number (ms)
            if (typeof field === 'number') return new Date(field);
            // string date
            const d = new Date(field);
            return isNaN(d.getTime()) ? null : d;
        }

        // loadGastos
        async function loadGastos() {
            try {
                const tableBody = document.getElementById('gastosTable');
                tableBody.innerHTML = '<tr><td colspan="4" class="loading">Cargando...</td></tr>';

                let snapshot;
                try {
                    const q = query(collection(db, 'gastos'), where('userId', '==', window.currentUser.uid), orderBy('timestamp', 'desc'));
                    snapshot = await getDocs(q);
                } catch (err) {
                    console.warn('OrderBy fall√≥ para gastos, cargando sin ordenar.', err);
                    showErrorHelper(err);
                    const q = query(collection(db, 'gastos'), where('userId', '==', window.currentUser.uid));
                    snapshot = await getDocs(q);
                }

                tableBody.innerHTML = '';
                if (!snapshot || snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:#999;">üìù No hay gastos registrados. ¬°Empieza a registrar tus gastos arriba!</td></tr>';
                    return;
                }

                const gastos = [];
                snapshot.forEach(s => gastos.push({ id: s.id, ...s.data() }));
                gastos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                gastos.forEach(g => {
                    const fechaDate = toDateSafe(g.fecha) || new Date(g.timestamp || Date.now());
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${fechaDate.toLocaleDateString('es-CR')}</td>
                        <td>${g.concepto || ''}</td>
                        <td style="font-weight:600;">‚Ç°${Number(g.monto || 0).toLocaleString('es-CR')}</td>
                        <td><button class="delete-btn" onclick="eliminarGasto('${g.id}')">üóëÔ∏è Eliminar</button></td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                console.error('‚ùå Error al cargar gastos:', error);
                showErrorHelper(error);
                const tableBody = document.getElementById('gastosTable');
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#dc3545;padding:20px;">Error al cargar gastos. Verifica el cuadro amarillo arriba.</td></tr>';
            }
        }

        // loadPedidos
        async function loadPedidos() {
            try {
                const tableBody = document.getElementById('pedidosTable');
                tableBody.innerHTML = '<tr><td colspan="7" class="loading">Cargando...</td></tr>';

                let snapshot;
                try {
                    const q = query(collection(db, 'pedidos'), where('userId', '==', window.currentUser.uid), orderBy('timestamp', 'desc'));
                    snapshot = await getDocs(q);
                } catch (err) {
                    console.warn('OrderBy fall√≥ para pedidos, cargando sin ordenar.', err);
                    showErrorHelper(err);
                    const q = query(collection(db, 'pedidos'), where('userId', '==', window.currentUser.uid));
                    snapshot = await getDocs(q);
                }

                tableBody.innerHTML = '';
                if (!snapshot || snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#999;">üì¶ No hay pedidos pendientes</td></tr>';
                    return;
                }

                const pedidos = [];
                snapshot.forEach(s => pedidos.push({ id: s.id, ...s.data() }));

                pedidos.sort((a, b) => {
                    const da = a.fechaEntrega ? new Date(a.fechaEntrega) : new Date(0);
                    const dbDate = b.fechaEntrega ? new Date(b.fechaEntrega) : new Date(0);
                    return da - dbDate;
                });

                pedidos.forEach(p => {
                    const fechaEntrega = p.fechaEntrega ? new Date(p.fechaEntrega).toLocaleDateString('es-CR') : '-';
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${p.nombre || ''}</td>
                        <td>${p.telefono || ''}</td>
                        <td>${p.postre || ''}</td>
                        <td style="font-weight:600;">‚Ç°${Number(p.precio || 0).toLocaleString('es-CR')}</td>
                        <td>${fechaEntrega}</td>
                        <td>${p.ruta || ''}</td>
                        <td><button class="delete-btn" onclick="eliminarPedido('${p.id}')">‚úÖ Completar</button></td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                console.error('‚ùå Error al cargar pedidos:', error);
                showErrorHelper(error);
                const tableBody = document.getElementById('pedidosTable');
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#dc3545;padding:20px;">Error al cargar pedidos. Verifica el cuadro amarillo arriba.</td></tr>';
            }
        }

        // loadIngresos
        async function loadIngresos() {
            try {
                const tableBody = document.getElementById('ingresosTable');
                tableBody.innerHTML = '<tr><td colspan="3" class="loading">Cargando...</td></tr>';

                let snapshot;
                try {
                    const q = query(collection(db, 'ingresos'), where('userId', '==', window.currentUser.uid), orderBy('timestamp', 'desc'));
                    snapshot = await getDocs(q);
                } catch (err) {
                    console.warn('OrderBy fall√≥ para ingresos, cargando sin ordenar.', err);
                    showErrorHelper(err);
                    const q = query(collection(db, 'ingresos'), where('userId', '==', window.currentUser.uid));
                    snapshot = await getDocs(q);
                }

                tableBody.innerHTML = '';
                if (!snapshot || snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;color:#999;">üí∞ No hay ingresos registrados</td></tr>';
                    return;
                }

                const ingresos = [];
                snapshot.forEach(s => ingresos.push({ id: s.id, ...s.data() }));
                ingresos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                ingresos.forEach(i => {
                    const fechaDate = toDateSafe(i.fecha) || new Date(i.timestamp || Date.now());
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${fechaDate.toLocaleDateString('es-CR')}</td>
                        <td>${i.cliente || ''}</td>
                        <td style="font-weight:600;color:#28a745;">‚Ç°${Number(i.monto || 0).toLocaleString('es-CR')}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } catch (error) {
                console.error('‚ùå Error al cargar ingresos:', error);
                showErrorHelper(error);
                const tableBody = document.getElementById('ingresosTable');
                tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#dc3545;padding:20px;">Error al cargar ingresos.</td></tr>';
            }
        }

        // updateStats: calcula totales seg√∫n periodo (day/week/month)
        window.updateStats = async () => {
            if (!window.currentUser) return;
            const period = document.getElementById('periodSelect').value;
            const now = new Date();
            let startDate;

            if (period === 'day') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
            } else if (period === 'week') {
                // Semana: lunes como inicio
                const day = now.getDay(); // 0 (domingo) .. 6 (s√°bado)
                const diffToMonday = (day === 0) ? -6 : (1 - day); // si es domingo, retrocede 6 d√≠as
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diffToMonday, 0, 0, 0, 0);
            } else { // month
                startDate = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
            }

            const startTs = startDate.getTime();

            try {
                // Gastos
                let totalGastos = 0;
                const gastosQ = query(collection(db, 'gastos'), where('userId', '==', window.currentUser.uid));
                const gastosSnap = await getDocs(gastosQ);
                gastosSnap.forEach(s => {
                    const data = s.data();
                    const fecha = toDateSafe(data.fecha) || (typeof data.timestamp === 'number' ? new Date(data.timestamp) : null);
                    if (fecha && fecha.getTime() >= startTs) totalGastos += Number(data.monto || 0);
                });

                // Ingresos
                let totalIngresos = 0;
                const ingresosQ = query(collection(db, 'ingresos'), where('userId', '==', window.currentUser.uid));
                const ingresosSnap = await getDocs(ingresosQ);
                ingresosSnap.forEach(s => {
                    const data = s.data();
                    const fecha = toDateSafe(data.fecha) || (typeof data.timestamp === 'number' ? new Date(data.timestamp) : null);
                    if (fecha && fecha.getTime() >= startTs) totalIngresos += Number(data.monto || 0);
                });

                const ganancia = totalIngresos - totalGastos;
                const margen = totalIngresos > 0 ? ((ganancia / totalIngresos) * 100).toFixed(1) : 0;

                document.getElementById('totalIngresos').textContent = '‚Ç°' + totalIngresos.toLocaleString('es-CR');
                document.getElementById('totalGastos').textContent = '‚Ç°' + totalGastos.toLocaleString('es-CR');
                document.getElementById('totalGanancia').textContent = '‚Ç°' + ganancia.toLocaleString('es-CR');
                document.getElementById('margen').textContent = margen + '%';

                console.log('üìä Estad√≠sticas actualizadas:', { totalIngresos, totalGastos, ganancia, margen: margen + '%' });
            } catch (error) {
                console.error('‚ùå Error al actualizar estad√≠sticas:', error);
                showErrorHelper(error);
            }
        };
    </script>
</body>
</html>
