<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gesti√≥n de Postres</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; }
        .container { max-width:1200px; margin:0 auto; padding:20px; }
        .login-container { display:flex; justify-content:center; align-items:center; min-height:100vh; }
        .login-box { background:white; padding:40px; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.3); width:100%; max-width:400px; }
        .login-box h2 { color:#667eea; margin-bottom:30px; text-align:center; }
        .input-group { margin-bottom:20px; }
        .input-group label { display:block; margin-bottom:5px; color:#333; font-weight:500; }
        .input-group input, .input-group select { width:100%; padding:12px; border:2px solid #e0e0e0; border-radius:8px; font-size:14px; transition:border-color .3s; }
        .input-group input:focus, .input-group select:focus { outline:none; border-color:#667eea; }
        .btn { width:100%; padding:12px; background:#667eea; color:white; border:none; border-radius:8px; font-size:16px; font-weight:600; cursor:pointer; transition:background .3s; }
        .btn:hover { background:#5568d3; }
        .btn-secondary { background:#6c757d; margin-top:10px; }
        .btn-secondary:hover { background:#5a6268; }
        .app-container { display:none; }
        .header { background:white; padding:20px; border-radius:15px; margin-bottom:20px; box-shadow:0 5px 15px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
        .header h1 { color:#667eea; }
        .logout-btn { padding:10px 20px; background:#dc3545; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600; }
        .tabs { display:flex; gap:10px; margin-bottom:20px; }
        .tab { flex:1; padding:15px; background:white; border:none; border-radius:10px; cursor:pointer; font-size:16px; font-weight:600; transition:all .3s; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
        .tab.active { background:#667eea; color:white; }
        .tab-content { display:none; background:white; padding:25px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.1); }
        .tab-content.active { display:block; }
        .form-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:20px; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:30px; }
        .stat-card { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:20px; border-radius:10px; box-shadow:0 3px 10px rgba(0,0,0,0.1); }
        .stat-card h3 { font-size:14px; margin-bottom:10px; opacity:0.9; }
        .stat-card .value { font-size:28px; font-weight:bold; }
        table { width:100%; border-collapse:collapse; margin-top:20px; }
        th, td { padding:12px; text-align:left; border-bottom:1px solid #e0e0e0; }
        th { background:#f8f9fa; font-weight:600; color:#333; }
        .delete-btn { background:#dc3545; color:white; border:none; padding:5px 12px; border-radius:5px; cursor:pointer; font-size:12px; }
        .delete-btn:hover { background:#c82333; }
        .edit-btn { background:#ffc107; color:#333; border:none; padding:5px 12px; border-radius:5px; cursor:pointer; font-size:12px; margin-right:5px; }
        .edit-btn:hover { background:#e0a800; }
        .status-ok { color:#28a745; font-weight:600; }
        .status-low { color:#dc3545; font-weight:600; }
        .item-comprado { text-decoration: line-through; opacity:0.6; background:#f0f0f0; }
        .checkbox-compra { width:20px; height:20px; cursor:pointer; }
        .alert { padding:12px; border-radius:8px; margin-bottom:20px; display:none; }
        .alert-success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
        .alert-error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
        .hidden { display:none; }
        .loading { text-align:center; padding:20px; color:#666; }
        .error-box { background:#fff3cd; border:2px solid #ffc107; padding:15px; border-radius:8px; margin:20px 0; }
        .error-box h4 { color:#856404; margin-bottom:10px; }
        .error-box code { display:block; background:#fff; padding:10px; border-radius:4px; margin-top:10px; font-size:12px; overflow-x:auto; }
    </style>
</head>
<body>
    <!-- LOGIN -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2>üç∞ Mi Emprendimiento de Postres</h2>
            <div id="loginAlert" class="alert"></div>
            <div class="input-group">
                <label>Correo Electr√≥nico</label>
                <input type="email" id="loginEmail" placeholder="tu@email.com" />
            </div>
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
            </div>
            <button class="btn" onclick="login()">Iniciar Sesi√≥n</button>
            <button class="btn btn-secondary" onclick="showRegister()">Registrarse</button>
        </div>
    </div>

    <!-- REGISTER -->
    <div id="registerScreen" class="login-container hidden">
        <div class="login-box">
            <h2>Crear Cuenta</h2>
            <div id="registerAlert" class="alert"></div>
            <div class="input-group">
                <label>Correo Electr√≥nico</label>
                <input type="email" id="registerEmail" placeholder="tu@email.com" />
            </div>
            <div class="input-group">
                <label>Contrase√±a</label>
                <input type="password" id="registerPassword" placeholder="M√≠nimo 6 caracteres" />
            </div>
            <button class="btn" onclick="register()">Crear Cuenta</button>
            <button class="btn btn-secondary" onclick="showLogin()">Volver al Login</button>
        </div>
    </div>

    <!-- APP -->
    <div id="appScreen" class="app-container">
        <div class="container">
            <div class="header">
                <h1>üç∞ Gesti√≥n de Postres</h1>
                <button class="logout-btn" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <div id="errorContainer"></div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab(event,'cuentas')">üìä Cuentas</button>
                <button class="tab" onclick="switchTab(event,'inventario')">üì¶ Inventario</button>
                <button class="tab" onclick="switchTab(event,'pedidos')">üç∞ Pedidos</button>
                <button class="tab" onclick="switchTab(event,'compras')">üõí Lista de Compras</button>
            </div>

            <div id="cuentasTab" class="tab-content active">
                <h2>Gesti√≥n de Cuentas</h2>

                <div class="input-group">
                    <label>Ver estad√≠sticas por: </label>
                    <select id="periodSelect" onchange="updateStats()">
                        <option value="day">Hoy</option>
                        <option value="week">Esta Semana</option>
                        <option value="month">Este Mes</option>
                    </select>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Ingresos</h3>
                        <div class="value" id="totalIngresos">‚Ç°0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Gastos</h3>
                        <div class="value" id="totalGastos">‚Ç°0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Ganancia</h3>
                        <div class="value" id="totalGanancia">‚Ç°0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Margen</h3>
                        <div class="value" id="margen">0%</div>
                    </div>
                </div>

                <h3>Registrar Gasto</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label>Concepto</label>
                        <input type="text" id="gastoConcepto" placeholder="Ej: Ingredientes, Envases, Transporte" />
                    </div>
                    <div class="input-group">
                        <label>Monto (‚Ç°)</label>
                        <input type="number" id="gastoMonto" placeholder="0" min="0" />
                    </div>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="gastoEsInventario" onchange="toggleInventarioFields()" style="width:auto;display:inline;margin-right:8px;" />
                        Este gasto es para inventario (ingredientes, envases, etc.)
                    </label>
                </div>
                
                <div id="camposInventarioGasto" class="hidden" style="border:2px solid #667eea; padding:15px; border-radius:8px; margin-bottom:15px; background:#f8f9ff;">
                    <h4 style="color:#667eea; margin-bottom:15px;">üì¶ Detalles del Producto</h4>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Nombre del Producto</label>
                            <input type="text" id="gastoProductoNombre" placeholder="Ej: Harina, Huevos, Envases" />
                        </div>
                        <div class="input-group">
                            <label>Cantidad</label>
                            <input type="number" id="gastoProductoCantidad" placeholder="0" min="0" step="0.1" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="input-group">
                            <label>Unidad</label>
                            <select id="gastoProductoUnidad">
                                <option value="kg">Kilogramos (kg)</option>
                                <option value="g">Gramos (g)</option>
                                <option value="L">Litros (L)</option>
                                <option value="ml">Mililitros (ml)</option>
                                <option value="unidad">Unidades</option>
                                <option value="paquete">Paquetes</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Stock M√≠nimo</label>
                            <input type="number" id="gastoProductoStockMin" placeholder="5" min="0" step="0.1" value="5" />
                        </div>
                    </div>
                </div>
                
                <button class="btn" onclick="registrarGasto()">üí∞ Registrar Gasto</button>

                <h3 style="margin-top:30px;">Historial de Gastos</h3>
                <table>
                    <thead>
                        <tr><th>Fecha</th><th>Concepto</th><th>Monto</th><th>Acci√≥n</th></tr>
                    </thead>
                    <tbody id="gastosTable"><tr><td colspan="4" class="loading">Cargando...</td></tr></tbody>
                </table>

                <h3 style="margin-top:30px;">Historial de Ingresos (Pedidos)</h3>
                <table>
                    <thead>
                        <tr><th>Fecha</th><th>Cliente</th><th>Monto</th></tr>
                    </thead>
                    <tbody id="ingresosTable"><tr><td colspan="3" class="loading">Cargando...</td></tr></tbody>
                </table>
            </div>

            <div id="inventarioTab" class="tab-content">
                <h2>Control de Inventario</h2>

                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Productos en Stock</h3>
                        <div class="value" id="totalProductos">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Valor Total Inventario</h3>
                        <div class="value" id="valorInventario">‚Ç°0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Productos Bajos</h3>
                        <div class="value" id="productosLowStock">0</div>
                    </div>
                </div>

                <h3>Agregar Producto al Inventario</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label>Nombre del Producto</label>
                        <input type="text" id="productoNombre" placeholder="Ej: Harina, Huevos, Leche" />
                    </div>
                    <div class="input-group">
                        <label>Cantidad</label>
                        <input type="number" id="productoCantidad" placeholder="0" min="0" step="0.1" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Unidad</label>
                        <select id="productoUnidad">
                            <option value="kg">Kilogramos (kg)</option>
                            <option value="g">Gramos (g)</option>
                            <option value="L">Litros (L)</option>
                            <option value="ml">Mililitros (ml)</option>
                            <option value="unidad">Unidades</option>
                            <option value="paquete">Paquetes</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Costo Total (‚Ç°)</label>
                        <input type="number" id="productoCosto" placeholder="0" min="0" />
                    </div>
                </div>
                <div class="input-group">
                    <label>Stock M√≠nimo (Alerta)</label>
                    <input type="number" id="productoStockMin" placeholder="5" min="0" step="0.1" />
                </div>
                <button class="btn" onclick="agregarProducto()">üì¶ Agregar al Inventario</button>

                <h3 style="margin-top:30px;">Inventario Actual</h3>
                <table>
                    <thead>
                        <tr><th>Producto</th><th>Cantidad</th><th>Costo Unitario</th><th>Valor Total</th><th>Stock M√≠n.</th><th>Estado</th><th>Acciones</th></tr>
                    </thead>
                    <tbody id="inventarioTable"><tr><td colspan="7" class="loading">Cargando...</td></tr></tbody>
                </table>

                <h3 style="margin-top:30px;">Usar/Consumir Producto</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label>Producto</label>
                        <select id="productoConsumir">
                            <option value="">Seleccionar producto...</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Cantidad a Consumir</label>
                        <input type="number" id="cantidadConsumir" placeholder="0" min="0" step="0.1" />
                    </div>
                </div>
                <button class="btn" onclick="consumirProducto()">üîª Registrar Consumo</button>
            </div>

            <div id="pedidosTab" class="tab-content">
                <h2>Gesti√≥n de Pedidos</h2>

                <h3>Nuevo Pedido</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label>Nombre del Cliente</label>
                        <input type="text" id="clienteNombre" placeholder="Juan P√©rez" />
                    </div>
                    <div class="input-group">
                        <label>Tel√©fono</label>
                        <input type="tel" id="clienteTelefono" placeholder="8888-8888" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group">
                        <label>Postre</label>
                        <input type="text" id="postreNombre" placeholder="Cheesecake de fresa" />
                    </div>
                    <div class="input-group">
                        <label>Precio (‚Ç°)</label>
                        <input type="number" id="postrePrecio" placeholder="0" min="0" />
                    </div>
                </div>
                <div class="input-group">
                    <label>Ruta de Entrega</label>
                    <input type="text" id="rutaEntrega" placeholder="Direcci√≥n completa" />
                </div>
                <div class="input-group">
                    <label>Fecha de Entrega</label>
                    <input type="date" id="fechaEntrega" />
                </div>
                <button class="btn" onclick="registrarPedido()" id="btnGuardarPedido">üì¶ Registrar Pedido</button>
                <button class="btn btn-secondary hidden" onclick="cancelarEdicionPedido()" id="btnCancelarPedido">Cancelar</button>

                <h3 style="margin-top:30px;">Pedidos Activos</h3>
                <table>
                    <thead>
                        <tr><th>Cliente</th><th>Tel√©fono</th><th>Postre</th><th>Precio</th><th>Entrega</th><th>Ruta</th><th>Acciones</th></tr>
                    </thead>
                    <tbody id="pedidosTable"><tr><td colspan="7" class="loading">Cargando...</td></tr></tbody>
                </table>
            </div>

            <div id="comprasTab" class="tab-content">
                <h2>üõí Lista de Compras</h2>
                <p style="color:#666; margin-bottom:20px;">Anota aqu√≠ lo que necesitas comprar para tu negocio. ¬°Nunca olvides un ingrediente!</p>

                <h3>Agregar Item a la Lista</h3>
                <div class="form-row">
                    <div class="input-group">
                        <label>¬øQu√© necesitas comprar?</label>
                        <input type="text" id="itemNombre" placeholder="Ej: 2kg de az√∫car, Moldes desechables" />
                    </div>
                    <div class="input-group">
                        <label>Cantidad Estimada (Opcional)</label>
                        <input type="text" id="itemCantidad" placeholder="Ej: 5 unidades, 2kg" />
                    </div>
                </div>
                <div class="input-group">
                    <label>Costo Estimado (‚Ç°) - Opcional</label>
                    <input type="number" id="itemCostoEstimado" placeholder="0" min="0" />
                </div>
                <div class="input-group">
                    <label>Categor√≠a</label>
                    <select id="itemCategoria">
                        <option value="ingredientes">ü•ö Ingredientes</option>
                        <option value="envases">üì¶ Envases y Empaques</option>
                        <option value="decoracion">üé® Decoraci√≥n</option>
                        <option value="herramientas">üîß Herramientas/Utensilios</option>
                        <option value="otros">üìå Otros</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Notas adicionales (Opcional)</label>
                    <input type="text" id="itemNotas" placeholder="Ej: Comprar en el supermercado X, marca Y" />
                </div>
                <button class="btn" onclick="agregarItemCompra()">‚ûï Agregar a la Lista</button>

                <div style="margin:30px 0; padding:15px; background:#f0f8ff; border-radius:10px; border-left:4px solid #667eea;">
                    <h3 style="color:#667eea; margin-bottom:10px;">üí∞ Presupuesto Total Estimado</h3>
                    <div style="font-size:24px; font-weight:bold; color:#667eea;" id="presupuestoTotal">‚Ç°0</div>
                </div>

                <h3 style="margin-top:30px;">üìù Mi Lista de Compras</h3>
                
                <div style="margin-bottom:15px;">
                    <label style="font-weight:600; margin-right:10px;">Filtrar por categor√≠a:</label>
                    <select id="filtroCategoria" onchange="filtrarListaCompras()" style="padding:8px; border-radius:5px; border:2px solid #e0e0e0;">
                        <option value="todas">Todas las categor√≠as</option>
                        <option value="ingredientes">ü•ö Ingredientes</option>
                        <option value="envases">üì¶ Envases y Empaques</option>
                        <option value="decoracion">üé® Decoraci√≥n</option>
                        <option value="herramientas">üîß Herramientas/Utensilios</option>
                        <option value="otros">üìå Otros</option>
                    </select>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th style="width:40px;">‚úì</th>
                            <th>Item</th>
                            <th>Cantidad</th>
                            <th>Costo Est.</th>
                            <th>Categor√≠a</th>
                            <th>Notas</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="comprasTable"><tr><td colspan="7" class="loading">Cargando...</td></tr></tbody>
                </table>

                <div style="margin-top:20px; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="btn" onclick="marcarTodosComprados()" style="flex:1; min-width:200px; background:#28a745;">‚úÖ Marcar Todos como Comprados</button>
                    <button class="btn btn-secondary" onclick="eliminarComprados()" style="flex:1; min-width:200px;">üóëÔ∏è Eliminar Items Comprados</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, orderBy, Timestamp, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDjwYd8J_9g7kfgluxZFWMKKOn2OoBkmBQ",
            authDomain: "postres-app-86dac.firebaseapp.com",
            projectId: "postres-app-86dac",
            storageBucket: "postres-app-86dac.firebasestorage.app",
            messagingSenderId: "353099071108",
            appId: "1:353099071108:web:88b2d032e4a2400d2a0cd1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.currentUser = null;
        window.editandoPedidoId = null;
        window.listaComprasCache = []; // Cache para filtrado

        function showErrorHelper(error) {
            const errorContainer = document.getElementById('errorContainer');
            if (!error) { errorContainer.innerHTML = ''; return; }

            if (error.code === 'permission-denied') {
                errorContainer.innerHTML = `
                    <div class="error-box">
                        <h4>üîí Error de Permisos de Firestore</h4>
                        <p>Las reglas de seguridad est√°n bloqueando el acceso. Sigue estos pasos:</p>
                        <ol>
                            <li>Ve a la <a href="https://console.firebase.google.com" target="_blank">Consola de Firebase</a></li>
                            <li>Selecciona tu proyecto: <strong>postres-app-86dac</strong></li>
                            <li>Ve a <strong>Firestore Database</strong> ‚Üí <strong>Reglas</strong></li>
                            <li>Copia y pega estas reglas:</li>
                        </ol>
                        <code>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}</code>
                        <p style="margin-top:10px;">Luego haz clic en <strong>Publicar</strong> y recarga esta p√°gina.</p>
                    </div>`;
            } else if (error.code === 'failed-precondition' || (error.message && error.message.includes('index'))) {
                const indexUrl = error.message ? error.message.match(/https:\/\/[^\s]+/) : null;
                errorContainer.innerHTML = `
                    <div class="error-box">
                        <h4>üìã Falta Crear √çndice en Firestore</h4>
                        <p>Firebase necesita un √≠ndice para esta consulta.</p>
                        ${indexUrl ? `<p><a href="${indexUrl[0]}" target="_blank" style="color:#667eea; font-weight:bold;">üëâ Haz clic aqu√≠ para crear el √≠ndice</a></p>` : ''}
                        <p>Despu√©s de crear el √≠ndice, espera 1-2 minutos y recarga la p√°gina.</p>
                    </div>`;
            } else {
                errorContainer.innerHTML = `<div class="error-box"><h4>Error</h4><p>${error.message || error}</p></div>`;
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('registerScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'block';
                loadData();
            } else {
                window.currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('appScreen').style.display = 'none';
            }
        });

        window.showRegister = () => {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('registerScreen').style.display = 'flex';
        };

        window.showLogin = () => {
            document.getElementById('registerScreen').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
        };

        window.register = async () => {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            if (!email || !password) { showAlert('registerAlert','Por favor completa todos los campos','error'); return; }
            if (password.length < 6) { showAlert('registerAlert','La contrase√±a debe tener al menos 6 caracteres','error'); return; }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showAlert('registerAlert','‚úÖ Cuenta creada exitosamente','success');
            } catch (error) {
                console.error('Error de registro:', error);
                let mensaje = 'Error al crear cuenta';
                if (error.code === 'auth/email-already-in-use') mensaje = 'Este correo ya est√° registrado';
                else if (error.code === 'auth/invalid-email') mensaje = 'Correo electr√≥nico inv√°lido';
                else if (error.code === 'auth/weak-password') mensaje = 'La contrase√±a es muy d√©bil';
                showAlert('registerAlert', mensaje, 'error');
            }
        };

        window.login = async () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { showAlert('loginAlert','Por favor completa todos los campos','error'); return; }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error('Error de login:', error);
                let mensaje = 'Error al iniciar sesi√≥n';
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') mensaje = 'Correo o contrase√±a incorrectos';
                else if (error.code === 'auth/invalid-email') mensaje = 'Correo electr√≥nico inv√°lido';
                showAlert('loginAlert', mensaje, 'error');
            }
        };

        window.logout = async () => {
            await signOut(auth);
        };

        function showAlert(elementId, message, type) {
            const alertDiv = document.getElementById(elementId);
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            setTimeout(() => alertDiv.style.display = 'none', 4000);
        }

        window.switchTab = (evt, tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            if (tab === 'cuentas') updateStats();
            if (tab === 'inventario') {
                loadInventario();
                updateInventarioStats();
            }
            if (tab === 'compras') {
                loadListaCompras();
            }
        };

        window.toggleInventarioFields = () => {
            const checkbox = document.getElementById('gastoEsInventario');
            const campos = document.getElementById('camposInventarioGasto');
            if (checkbox.checked) {
                campos.classList.remove('hidden');
            } else {
                campos.classList.add('hidden');
            }
        };

        window.registrarGasto = async () => {
            const concepto = document.getElementById('gastoConcepto').value.trim();
            const monto = parseFloat(document.getElementById('gastoMonto').value);
            const esInventario = document.getElementById('gastoEsInventario').checked;
            
            if (!concepto || !monto || monto <= 0) { 
                alert('‚ö†Ô∏è Por favor completa todos los campos correctamente'); 
                return; 
            }

            // Si es inventario, validar campos adicionales
            if (esInventario) {
                const nombreProducto = document.getElementById('gastoProductoNombre').value.trim();
                const cantidad = parseFloat(document.getElementById('gastoProductoCantidad').value);
                const unidad = document.getElementById('gastoProductoUnidad').value;
                const stockMin = parseFloat(document.getElementById('gastoProductoStockMin').value) || 5;

                if (!nombreProducto || !cantidad || cantidad <= 0) {
                    alert('‚ö†Ô∏è Por favor completa los detalles del producto para inventario');
                    return;
                }

                try {
                    // Registrar gasto
                    const gastoData = {
                        userId: window.currentUser.uid,
                        concepto,
                        monto,
                        fecha: Timestamp.now(),
                        timestamp: Date.now(),
                        esInventario: true
                    };
                    await addDoc(collection(db, 'gastos'), gastoData);

                    // Agregar al inventario
                    const productoData = {
                        userId: window.currentUser.uid,
                        nombre: nombreProducto,
                        cantidad,
                        unidad,
                        costoTotal: monto,
                        costoUnitario: monto / cantidad,
                        stockMin,
                        fecha: Timestamp.now(),
                        timestamp: Date.now()
                    };
                    await addDoc(collection(db, 'inventario'), productoData);

                    // Limpiar formulario
                    document.getElementById('gastoConcepto').value = '';
                    document.getElementById('gastoMonto').value = '';
                    document.getElementById('gastoEsInventario').checked = false;
                    document.getElementById('gastoProductoNombre').value = '';
                    document.getElementById('gastoProductoCantidad').value = '';
                    document.getElementById('gastoProductoStockMin').value = '5';
                    document.getElementById('camposInventarioGasto').classList.add('hidden');

                    await loadGastos();
                    await loadInventario();
                    await updateStats();
                    await updateInventarioStats();

                    alert(`‚úÖ Gasto registrado y producto agregado al inventario\nüí∞ Monto: ‚Ç°${monto.toLocaleString()}\nüìù Concepto: ${concepto}\nüì¶ Producto: ${nombreProducto} (${cantidad} ${unidad})`);
                } catch (error) {
                    console.error('‚ùå Error al registrar gasto con inventario:', error);
                    showErrorHelper(error);
                    alert('Error al registrar. Revisa el cuadro amarillo arriba.');
                }
            } else {
                // Gasto normal sin inventario
                try {
                    const gastoData = {
                        userId: window.currentUser.uid,
                        concepto,
                        monto,
                        fecha: Timestamp.now(),
                        timestamp: Date.now(),
                        esInventario: false
                    };
                    await addDoc(collection(db, 'gastos'), gastoData);
                    
                    document.getElementById('gastoConcepto').value = '';
                    document.getElementById('gastoMonto').value = '';
                    
                    await loadGastos();
                    await updateStats();
                    
                    alert(`‚úÖ Gasto registrado exitosamente\nüí∞ Monto: ‚Ç°${monto.toLocaleString()}\nüìù Concepto: ${concepto}`);
                } catch (error) {
                    console.error('‚ùå Error al registrar gasto:', error);
                    showErrorHelper(error);
                    alert('Error al registrar gasto');
                }
            }
        };

        window.registrarPedido = async () => {
            const nombre = document.getElementById('clienteNombre').value.trim();
            const telefono = document.getElementById('clienteTelefono').value.trim();
            const postre = document.getElementById('postreNombre').value.trim();
            const precio = parseFloat(document.getElementById('postrePrecio').value);
            const ruta = document.getElementById('rutaEntrega').value.trim();
            const fechaEntrega = document.getElementById('fechaEntrega').value;
            if (!nombre || !telefono || !postre || !precio || !ruta || !fechaEntrega || precio <= 0) { 
                alert('‚ö†Ô∏è Por favor completa todos los campos correctamente'); 
                return; 
            }

            try {
                if (window.editandoPedidoId) {
                    const pedidoRef = doc(db, 'pedidos', window.editandoPedidoId);
                    await setDoc(pedidoRef, {
                        userId: window.currentUser.uid,
                        nombre, telefono, postre, precio, ruta, fechaEntrega,
                        fecha: Timestamp.now(),
                        timestamp: Date.now()
                    });
                    alert(`‚úÖ Pedido actualizado exitosamente`);
                    window.editandoPedidoId = null;
                    document.getElementById('btnGuardarPedido').textContent = 'üì¶ Registrar Pedido';
                    document.getElementById('btnCancelarPedido').classList.add('hidden');
                } else {
                    const pedidoData = {
                        userId: window.currentUser.uid,
                        nombre, telefono, postre, precio, ruta, fechaEntrega,
                        fecha: Timestamp.now(),
                        timestamp: Date.now()
                    };
                    await addDoc(collection(db, 'pedidos'), pedidoData);

                    const ingresoData = {
                        userId: window.currentUser.uid,
                        cliente: nombre,
                        monto: precio,
                        fecha: Timestamp.now(),
                        timestamp: Date.now()
                    };
                    await addDoc(collection(db, 'ingresos'), ingresoData);
                    alert(`‚úÖ Pedido registrado exitosamente\nüë§ Cliente: ${nombre}\nüç∞ Postre: ${postre}\nüí∞ Precio: ‚Ç°${precio.toLocaleString()}`);
                }

                document.getElementById('clienteNombre').value = '';
                document.getElementById('clienteTelefono').value = '';
                document.getElementById('postreNombre').value = '';
                document.getElementById('postrePrecio').value = '';
                document.getElementById('rutaEntrega').value = '';
                document.getElementById('fechaEntrega').value = '';

                await loadPedidos();
                await loadIngresos();
                await updateStats();
            } catch (error) {
                console.error('‚ùå Error al registrar pedido:', error);
                showErrorHelper(error);
                alert('Error al registrar pedido. Revisa la consola y el cuadro amarillo arriba.');
            }
        };

        window.editarPedido = async (id) => {
            try {
                const pedidoRef = doc(db, 'pedidos', id);
                const pedidoSnap = await getDoc(pedidoRef);
                if (!pedidoSnap.exists()) {
                    alert('Pedido no encontrado');
                    return;
                }
                
                const p = pedidoSnap.data();
                document.getElementById('clienteNombre').value = p.nombre || '';
                document.getElementById('clienteTelefono').value = p.telefono || '';
                document.getElementById('postreNombre').value = p.postre || '';
                document.getElementById('postrePrecio').value = p.precio || '';
                document.getElementById('rutaEntrega').value = p.ruta || '';
                document.getElementById('fechaEntrega').value = p.fechaEntrega || '';
                
                window.editandoPedidoId = id;
                document.getElementById('btnGuardarPedido').textContent = 'üíæ Guardar Cambios';
                document.getElementById('btnCancelarPedido').classList.remove('hidden');
                
                document.getElementById('pedidosTab').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error al editar pedido:', error);
                alert('Error al cargar pedido: ' + error.message);
            }
        };

        window.cancelarEdicionPedido = () => {
            window.editandoPedidoId = null;
            document.getElementById('btnGuardarPedido').textContent = 'üì¶ Registrar Pedido';
            document.getElementById('btnCancelarPedido').classList.add('hidden');
            document.getElementById('clienteNombre').value = '';
            document.getElementById('clienteTelefono').value = '';
            document.getElementById('postreNombre').value = '';
            document.getElementById('postrePrecio').value = '';
            document.getElementById('rutaEntrega').value = '';
            document.getElementById('fechaEntrega').value = '';
        };

        window.eliminarGasto = async (id) => {
            if (!confirm('¬øEst√°s seguro de eliminar este gasto?')) return;
            try {
                await deleteDoc(doc(db, 'gastos', id));
                await loadGastos();
                await updateStats();
                alert('‚úÖ Gasto eliminado');
            } catch (error) {
                console.error('Error al eliminar gasto:', error);
                alert('Error al eliminar: ' + (error.message || error));
            }
        };

        window.eliminarPedido = async (id) => {
            if (!confirm('¬øEst√°s seguro de eliminar este pedido definitivamente?')) return;
            try {
                await deleteDoc(doc(db, 'pedidos', id));
                await loadPedidos();
                alert('‚úÖ Pedido eliminado');
            } catch (error) {
                console.error('Error al eliminar pedido:', error);
                alert('Error al eliminar: ' + (error.message || error));
            }
        };

        window.completarPedido = async (id) => {
            if (!confirm('¬øMarcar este pedido como completado?')) return;
            try {
                await deleteDoc(doc(db, 'pedidos', id));
                await loadPedidos();
                alert('‚úÖ Pedido completado');
            } catch (error) {
                console.error('Error al completar pedido:', error);
                alert('Error al completar: ' + (error.message || error));
            }
        };

        async function loadData() {
            try {
                await Promise.all([loadGastos(), loadPedidos(), loadIngresos(), loadInventario(), loadListaCompras()]);
                await updateStats();
                await updateInventarioStats();
            } catch (err) {
                console.error('Error cargando datos iniciales:', err);
            }
        }

        function toDateSafe(field) {
            if (!field) return null;
            if (typeof field.toDate === 'function') return field.toDate();
            if (typeof field === 'number') return new Date(field);
            const d = new Date(field);
            return isNaN(d.getTime()) ? null : d;
        }

        async function loadGastos() {
            try {
                const table = document.getElementById('gastosTable');
                table.innerHTML = '<tr><td colspan="4" class="loading">Cargando...</td></tr>';

                let snapshot;
                try {
                    const q = query(collection(db, 'gastos'), where('userId', '==', window.currentUser.uid), orderBy('timestamp', 'desc'));
                    snapshot = await getDocs(q);
                } catch (err) {
                    console.warn('OrderBy fall√≥ para gastos, cargando sin ordenar.', err);
                    showErrorHelper(err);
                    const q = query(collection(db, 'gastos'), where('userId', '==', window.currentUser.uid));
                    snapshot = await getDocs(q);
                }

                table.innerHTML = '';
                if (!snapshot || snapshot.empty) {
                    table.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:#999;">üìù No hay gastos registrados. ¬°Empieza a registrar tus gastos arriba!</td></tr>';
                    return;
                }

                const gastos = [];
                snapshot.forEach(s => gastos.push({ id: s.id, ...s.data() }));
                gastos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                gastos.forEach(g => {
                    const fechaDate = toDateSafe(g.fecha) || new Date(g.timestamp || Date.now());
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${fechaDate.toLocaleDateString('es-CR')}</td>
                        <td>${g.concepto || ''}</td>
                        <td style="font-weight:600;">‚Ç°${Number(g.monto || 0).toLocaleString('es-CR')}</td>
                        <td><button class="delete-btn" onclick="eliminarGasto('${g.id}')">üóëÔ∏è Eliminar</button></td>
                    `;
                });
            } catch (error) {
                console.error('‚ùå Error al cargar gastos:', error);
                showErrorHelper(error);
                const table = document.getElementById('gastosTable');
                table.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#dc3545;padding:20px;">Error al cargar gastos. Verifica el cuadro amarillo arriba.</td></tr>';
            }
        }

        async function loadPedidos() {
            try {
                const table = document.getElementById('pedidosTable');
                table.innerHTML = '<tr><td colspan="7" class="loading">Cargando...</td></tr>';

                let snapshot;
                try {
                    const q = query(collection(db, 'pedidos'), where('userId', '==', window.currentUser.uid), orderBy('timestamp', 'desc'));
                    snapshot = await getDocs(q);
                } catch (err) {
                    console.warn('OrderBy fall√≥ para pedidos, cargando sin ordenar.', err);
                    showErrorHelper(err);
                    const q = query(collection(db, 'pedidos'), where('userId', '==', window.currentUser.uid));
                    snapshot = await getDocs(q);
                }

                table.innerHTML = '';
                if (!snapshot || snapshot.empty) {
                    table.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#999;">üì¶ No hay pedidos pendientes</td></tr>';
                    return;
                }

                const pedidos = [];
                snapshot.forEach(s => pedidos.push({ id: s.id, ...s.data() }));

                pedidos.sort((a, b) => {
                    const da = a.fechaEntrega ? new Date(a.fechaEntrega) : new Date(0);
                    const dbDate = b.fechaEntrega ? new Date(b.fechaEntrega) : new Date(0);
                    return da - dbDate;
                });

                pedidos.forEach(p => {
                    const fechaEntrega = p.fechaEntrega ? new Date(p.fechaEntrega).toLocaleDateString('es-CR') : '-';
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${p.nombre || ''}</td>
                        <td>${p.telefono || ''}</td>
                        <td>${p.postre || ''}</td>
                        <td style="font-weight:600;">‚Ç°${Number(p.precio || 0).toLocaleString('es-CR')}</td>
                        <td>${fechaEntrega}</td>
                        <td>${p.ruta || ''}</td>
                        <td>
                            <button class="edit-btn" onclick="editarPedido('${p.id}')">‚úèÔ∏è Editar</button>
                            <button class="delete-btn" onclick="completarPedido('${p.id}')">‚úÖ Completar</button>
                            <button class="delete-btn" onclick="eliminarPedido('${p.id}')" style="background:#6c757d;">üóëÔ∏è</button>
                        </td>
                    `;
                });
            } catch (error) {
                console.error('‚ùå Error al cargar pedidos:', error);
                showErrorHelper(error);
                const table = document.getElementById('pedidosTable');
                table.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#dc3545;padding:20px;">Error al cargar pedidos. Verifica el cuadro amarillo arriba.</td></tr>';
            }
        }

        async function loadIngresos() {
            try {
                const table = document.getElementById('ingresosTable');
                table.innerHTML = '<tr><td colspan="3" class="loading">Cargando...</td></tr>';

                let snapshot;
                try {
                    const q = query(collection(db, 'ingresos'), where('userId', '==', window.currentUser.uid), orderBy('timestamp', 'desc'));
                    snapshot = await getDocs(q);
                } catch (err) {
                    console.warn('OrderBy fall√≥ para ingresos, cargando sin ordenar.', err);
                    showErrorHelper(err);
                    const q = query(collection(db, 'ingresos'), where('userId', '==', window.currentUser.uid));
                    snapshot = await getDocs(q);
                }

                table.innerHTML = '';
                if (!snapshot || snapshot.empty) {
                    table.innerHTML = '<tr><td colspan="3" style="text-align:center;padding:20px;color:#999;">üí∞ No hay ingresos registrados</td></tr>';
                    return;
                }

                const ingresos = [];
                snapshot.forEach(s => ingresos.push({ id: s.id, ...s.data() }));
                ingresos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                ingresos.forEach(i => {
                    const fechaDate = toDateSafe(i.fecha) || new Date(i.timestamp || Date.now());
                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${fechaDate.toLocaleDateString('es-CR')}</td>
                        <td>${i.cliente || ''}</td>
                        <td style="font-weight:600;color:#28a745;">‚Ç°${Number(i.monto || 0).toLocaleString('es-CR')}</td>
                    `;
                });
            } catch (error) {
                console.error('‚ùå Error al cargar ingresos:', error);
                showErrorHelper(error);
                const table = document.getElementById('ingresosTable');
                table.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#dc3545;padding:20px;">Error al cargar ingresos.</td></tr>';
            }
        }

        window.updateStats = async () => {
            if (!window.currentUser) return;
            const period = document.getElementById('periodSelect').value;
            const now = new Date();
            let startDate;

            if (period === 'day') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0, 0);
            } else if (period === 'week') {
                const day = now.getDay();
                const diffToMonday = (day === 0) ? -6 : (1 - day);
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() + diffToMonday, 0, 0, 0, 0);
            } else {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0, 0);
            }

            const startTs = startDate.getTime();

            try {
                let totalGastos = 0;
                const gastosQ = query(collection(db, 'gastos'), where('userId', '==', window.currentUser.uid));
                const gastosSnap = await getDocs(gastosQ);
                gastosSnap.forEach(s => {
                    const data = s.data();
                    const fecha = toDateSafe(data.fecha) || (typeof data.timestamp === 'number' ? new Date(data.timestamp) : null);
                    if (fecha && fecha.getTime() >= startTs) totalGastos += Number(data.monto || 0);
                });

                let totalIngresos = 0;
                const ingresosQ = query(collection(db, 'ingresos'), where('userId', '==', window.currentUser.uid));
                const ingresosSnap = await getDocs(ingresosQ);
                ingresosSnap.forEach(s => {
                    const data = s.data();
                    const fecha = toDateSafe(data.fecha) || (typeof data.timestamp === 'number' ? new Date(data.timestamp) : null);
                    if (fecha && fecha.getTime() >= startTs) totalIngresos += Number(data.monto || 0);
                });

                const ganancia = totalIngresos - totalGastos;
                const margen = totalIngresos > 0 ? ((ganancia / totalIngresos) * 100).toFixed(1) : 0;

                document.getElementById('totalIngresos').textContent = '‚Ç°' + totalIngresos.toLocaleString('es-CR');
                document.getElementById('totalGastos').textContent = '‚Ç°' + totalGastos.toLocaleString('es-CR');
                document.getElementById('totalGanancia').textContent = '‚Ç°' + ganancia.toLocaleString('es-CR');
                document.getElementById('margen').textContent = margen + '%';

                console.log('üìä Estad√≠sticas actualizadas:', { totalIngresos, totalGastos, ganancia, margen: margen + '%' });
            } catch (error) {
                console.error('‚ùå Error al actualizar estad√≠sticas:', error);
                showErrorHelper(error);
            }
        };

        window.agregarProducto = async () => {
            const nombre = document.getElementById('productoNombre').value.trim();
            const cantidad = parseFloat(document.getElementById('productoCantidad').value);
            const unidad = document.getElementById('productoUnidad').value;
            const costo = parseFloat(document.getElementById('productoCosto').value);
            const stockMin = parseFloat(document.getElementById('productoStockMin').value) || 5;

            if (!nombre || !cantidad || cantidad <= 0 || !costo || costo <= 0) {
                alert('‚ö†Ô∏è Por favor completa todos los campos correctamente');
                return;
            }

            try {
                const productoData = {
                    userId: window.currentUser.uid,
                    nombre,
                    cantidad,
                    unidad,
                    costoTotal: costo,
                    costoUnitario: costo / cantidad,
                    stockMin,
                    fecha: Timestamp.now(),
                    timestamp: Date.now()
                };

                await addDoc(collection(db, 'inventario'), productoData);

                const gastoData = {
                    userId: window.currentUser.uid,
                    concepto: `Compra inventario: ${nombre}`,
                    monto: costo,
                    fecha: Timestamp.now(),
                    timestamp: Date.now()
                };
                await addDoc(collection(db, 'gastos'), gastoData);

                document.getElementById('productoNombre').value = '';
                document.getElementById('productoCantidad').value = '';
                document.getElementById('productoCosto').value = '';
                document.getElementById('productoStockMin').value = '';

                await loadInventario();
                await loadGastos();
                await updateInventarioStats();
                await updateStats();

                alert(`‚úÖ Producto agregado al inventario\nüì¶ ${nombre}\nüí∞ Costo: ‚Ç°${costo.toLocaleString()}`);
            } catch (error) {
                console.error('Error al agregar producto:', error);
                showErrorHelper(error);
                alert('Error al agregar producto');
            }
        };

        window.consumirProducto = async () => {
            const select = document.getElementById('productoConsumir');
            const productoId = select.value;
            const cantidadConsumir = parseFloat(document.getElementById('cantidadConsumir').value);

            if (!productoId || !cantidadConsumir || cantidadConsumir <= 0) {
                alert('‚ö†Ô∏è Selecciona un producto y cantidad v√°lida');
                return;
            }

            try {
                const productoRef = doc(db, 'inventario', productoId);
                const productoSnap = await getDoc(productoRef);
                
                if (!productoSnap.exists()) {
                    alert('Producto no encontrado');
                    return;
                }

                const producto = productoSnap.data();
                const nuevaCantidad = producto.cantidad - cantidadConsumir;

                if (nuevaCantidad < 0) {
                    alert(`‚ö†Ô∏è No hay suficiente ${producto.nombre}.\nDisponible: ${producto.cantidad} ${producto.unidad}`);
                    return;
                }

                await setDoc(productoRef, {
                    ...producto,
                    cantidad: nuevaCantidad
                });

                document.getElementById('cantidadConsumir').value = '';
                await loadInventario();
                await updateInventarioStats();

                if (nuevaCantidad <= producto.stockMin) {
                    alert(`‚úÖ Consumo registrado\n‚ö†Ô∏è ALERTA: Stock bajo de ${producto.nombre}\nQueda: ${nuevaCantidad} ${producto.unidad}`);
                } else {
                    alert(`‚úÖ Consumo registrado\n${producto.nombre}: ${nuevaCantidad} ${producto.unidad} restantes`);
                }
            } catch (error) {
                console.error('Error al consumir producto:', error);
                alert('Error al registrar consumo');
            }
        };

        window.eliminarProducto = async (id) => {
            if (!confirm('¬øEliminar este producto del inventario?')) return;
            try {
                await deleteDoc(doc(db, 'inventario', id));
                await loadInventario();
                await updateInventarioStats();
                alert('‚úÖ Producto eliminado');
            } catch (error) {
                console.error('Error al eliminar producto:', error);
                alert('Error al eliminar');
            }
        };

        async function loadInventario() {
            try {
                const table = document.getElementById('inventarioTable');
                const select = document.getElementById('productoConsumir');
                
                table.innerHTML = '<tr><td colspan="7" class="loading">Cargando...</td></tr>';
                select.innerHTML = '<option value="">Seleccionar producto...</option>';

                let snapshot;
                try {
                    const q = query(collection(db, 'inventario'), where('userId', '==', window.currentUser.uid), orderBy('timestamp', 'desc'));
                    snapshot = await getDocs(q);
                } catch (err) {
                    console.warn('OrderBy fall√≥ para inventario, cargando sin ordenar.', err);
                    const q = query(collection(db, 'inventario'), where('userId', '==', window.currentUser.uid));
                    snapshot = await getDocs(q);
                }

                table.innerHTML = '';
                if (!snapshot || snapshot.empty) {
                    table.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#999;">üì¶ No hay productos en inventario</td></tr>';
                    return;
                }

                const productos = [];
                snapshot.forEach(s => productos.push({ id: s.id, ...s.data() }));
                productos.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                productos.forEach(p => {
                    const valorTotal = p.cantidad * p.costoUnitario;
                    const estado = p.cantidad <= p.stockMin ? 
                        `<span class="status-low">‚úÖ Disponible</span>` : 
                        `<span class="status-ok">‚úÖ OK</span>`;

                    const row = table.insertRow();
                    row.innerHTML = `
                        <td>${p.nombre}</td>
                        <td style="font-weight:600;">${p.cantidad} ${p.unidad}</td>
                        <td>‚Ç°${p.costoUnitario.toFixed(2)}</td>
                        <td style="font-weight:600;">‚Ç°${valorTotal.toLocaleString('es-CR')}</td>
                        <td>${p.stockMin} ${p.unidad}</td>
                        <td>${estado}</td>
                        <td><button class="delete-btn" onclick="eliminarProducto('${p.id}')">üóëÔ∏è</button></td>
                    `;

                    const option = document.createElement('option');
                    option.value = p.id;
                    option.textContent = `${p.nombre} (${p.cantidad} ${p.unidad})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error al cargar inventario:', error);
                showErrorHelper(error);
                const table = document.getElementById('inventarioTable');
                table.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#dc3545;padding:20px;">Error al cargar inventario</td></tr>';
            }
        }

        async function updateInventarioStats() {
            try {
                const q = query(collection(db, 'inventario'), where('userId', '==', window.currentUser.uid));
                const snapshot = await getDocs(q);

                let totalProductos = 0;
                let valorTotal = 0;
                let productosLowStock = 0;

                snapshot.forEach(s => {
                    const p = s.data();
                    totalProductos++;
                    valorTotal += (p.cantidad * p.costoUnitario);
                    if (p.cantidad <= p.stockMin) productosLowStock++;
                });

                document.getElementById('totalProductos').textContent = totalProductos;
                document.getElementById('valorInventario').textContent = '‚Ç°' + valorTotal.toLocaleString('es-CR');
                document.getElementById('productosLowStock').textContent = productosLowStock;
            } catch (error) {
                console.error('Error al actualizar stats de inventario:', error);
            }
        }

        // ==================== LISTA DE COMPRAS ====================

        window.agregarItemCompra = async () => {
            const nombre = document.getElementById('itemNombre').value.trim();
            const cantidad = document.getElementById('itemCantidad').value.trim();
            const costoEstimado = parseFloat(document.getElementById('itemCostoEstimado').value) || 0;
            const categoria = document.getElementById('itemCategoria').value;
            const notas = document.getElementById('itemNotas').value.trim();

            if (!nombre) {
                alert('‚ö†Ô∏è Por favor escribe qu√© necesitas comprar');
                return;
            }

            try {
                const itemData = {
                    userId: window.currentUser.uid,
                    nombre,
                    cantidad: cantidad || '-',
                    costoEstimado,
                    categoria,
                    notas: notas || '-',
                    comprado: false,
                    fecha: Timestamp.now(),
                    timestamp: Date.now()
                };

                await addDoc(collection(db, 'listaCompras'), itemData);

                document.getElementById('itemNombre').value = '';
                document.getElementById('itemCantidad').value = '';
                document.getElementById('itemCostoEstimado').value = '';
                document.getElementById('itemNotas').value = '';

                await loadListaCompras();
                alert(`‚úÖ Item agregado a tu lista de compras\nüìù ${nombre}`);
            } catch (error) {
                console.error('Error al agregar item:', error);
                showErrorHelper(error);
                alert('Error al agregar item');
            }
        };

        window.marcarComprado = async (id, comprado) => {
            try {
                const itemRef = doc(db, 'listaCompras', id);
                const itemSnap = await getDoc(itemRef);
                
                if (!itemSnap.exists()) return;

                await setDoc(itemRef, {
                    ...itemSnap.data(),
                    comprado: comprado
                });

                await loadListaCompras();
            } catch (error) {
                console.error('Error al marcar item:', error);
                alert('Error al actualizar item');
            }
        };

        window.eliminarItemCompra = async (id) => {
            if (!confirm('¬øEliminar este item de la lista?')) return;
            try {
                await deleteDoc(doc(db, 'listaCompras', id));
                await loadListaCompras();
                alert('‚úÖ Item eliminado');
            } catch (error) {
                console.error('Error al eliminar item:', error);
                alert('Error al eliminar');
            }
        };

        window.marcarTodosComprados = async () => {
            if (!confirm('¬øMarcar todos los items como comprados?')) return;
            try {
                const q = query(collection(db, 'listaCompras'), where('userId', '==', window.currentUser.uid), where('comprado', '==', false));
                const snapshot = await getDocs(q);
                
                const promises = [];
                snapshot.forEach(s => {
                    const itemRef = doc(db, 'listaCompras', s.id);
                    promises.push(setDoc(itemRef, { ...s.data(), comprado: true }));
                });

                await Promise.all(promises);
                await loadListaCompras();
                alert('‚úÖ Todos los items marcados como comprados');
            } catch (error) {
                console.error('Error:', error);
                alert('Error al marcar items');
            }
        };

        window.eliminarComprados = async () => {
            if (!confirm('¬øEliminar todos los items comprados de la lista?')) return;
            try {
                const q = query(collection(db, 'listaCompras'), where('userId', '==', window.currentUser.uid), where('comprado', '==', true));
                const snapshot = await getDocs(q);
                
                const promises = [];
                snapshot.forEach(s => {
                    promises.push(deleteDoc(doc(db, 'listaCompras', s.id)));
                });

                await Promise.all(promises);
                await loadListaCompras();
                alert('‚úÖ Items comprados eliminados');
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar items');
            }
        };

        window.filtrarListaCompras = () => {
            const filtro = document.getElementById('filtroCategoria').value;
            const table = document.getElementById('comprasTable');
            table.innerHTML = '';

            let itemsFiltrados = window.listaComprasCache;
            if (filtro !== 'todas') {
                itemsFiltrados = window.listaComprasCache.filter(item => item.categoria === filtro);
            }

            if (itemsFiltrados.length === 0) {
                table.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#999;">No hay items en esta categor√≠a</td></tr>';
                return;
            }

            const categoriaEmoji = {
                'ingredientes': 'ü•ö',
                'envases': 'üì¶',
                'decoracion': 'üé®',
                'herramientas': 'üîß',
                'otros': 'üìå'
            };

            itemsFiltrados.forEach(item => {
                const row = table.insertRow();
                if (item.comprado) row.classList.add('item-comprado');
                
                row.innerHTML = `
                    <td><input type="checkbox" class="checkbox-compra" ${item.comprado ? 'checked' : ''} onchange="marcarComprado('${item.id}', this.checked)" /></td>
                    <td style="font-weight:600;">${item.nombre}</td>
                    <td>${item.cantidad}</td>
                    <td>${item.costoEstimado > 0 ? '‚Ç°' + item.costoEstimado.toLocaleString('es-CR') : '-'}</td>
                    <td>${categoriaEmoji[item.categoria]} ${item.categoria.charAt(0).toUpperCase() + item.categoria.slice(1)}</td>
                    <td style="font-size:13px; color:#666;">${item.notas}</td>
                    <td><button class="delete-btn" onclick="eliminarItemCompra('${item.id}')">üóëÔ∏è</button></td>
                `;
            });
        };

        async function loadListaCompras() {
            try {
                const table = document.getElementById('comprasTable');
                table.innerHTML = '<tr><td colspan="7" class="loading">Cargando...</td></tr>';

                let snapshot;
                try {
                    const q = query(collection(db, 'listaCompras'), where('userId', '==', window.currentUser.uid), orderBy('timestamp', 'desc'));
                    snapshot = await getDocs(q);
                } catch (err) {
                    console.warn('OrderBy fall√≥ para lista de compras, cargando sin ordenar.', err);
                    const q = query(collection(db, 'listaCompras'), where('userId', '==', window.currentUser.uid));
                    snapshot = await getDocs(q);
                }

                table.innerHTML = '';
                if (!snapshot || snapshot.empty) {
                    table.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:20px;color:#999;">üìù No hay items en tu lista de compras</td></tr>';
                    window.listaComprasCache = [];
                    document.getElementById('presupuestoTotal').textContent = '‚Ç°0';
                    return;
                }

                const items = [];
                let presupuestoTotal = 0;

                snapshot.forEach(s => {
                    const item = { id: s.id, ...s.data() };
                    items.push(item);
                    if (!item.comprado && item.costoEstimado > 0) {
                        presupuestoTotal += item.costoEstimado;
                    }
                });

                items.sort((a, b) => {
                    if (a.comprado !== b.comprado) return a.comprado ? 1 : -1;
                    return (b.timestamp || 0) - (a.timestamp || 0);
                });

                window.listaComprasCache = items;
                document.getElementById('presupuestoTotal').textContent = '‚Ç°' + presupuestoTotal.toLocaleString('es-CR');
                document.getElementById('filtroCategoria').value = 'todas';
                
                filtrarListaCompras();
            } catch (error) {
                console.error('Error al cargar lista de compras:', error);
                showErrorHelper(error);
                const table = document.getElementById('comprasTable');
                table.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#dc3545;padding:20px;">Error al cargar lista de compras</td></tr>';
            }
        }
    </script>
</body>
</html>

